#include <Windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

// Ejecución 1  
// 008BA000 -> DECLARACIÓN EN .DATA
// 01280000 -> SHELLCODE EN MEMORIA


unsigned char payload [] = {
		0x90, // NOP
		0x90, // NOP
		0xcc, // INT3 
		0xc3  // RET 
	};

int main(void){

	void * exec_mem;
	BOOL rv; 
	HANDLE th; // define a HANDLE
	DWORD oldprotect = 0;
	
	// 4 byte payload that returns control to debugger when attached
	
	
	unsigned int payload_size = 4;
	
	
	// 1. Allocate memory 
	
	exec_mem =  VirtualAlloc(0, payload_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE );
	printf("Memory allocated succesfully!");
	
	// 2. Copy our shellcode to the allocate memory
	
	RtlMoveMemory(exec_mem, payload, payload_size);
	
	// 3. Make allocated memory executable
	
	rv = VirtualProtect(exec_mem, payload_size, PAGE_EXECUTE_READ, &oldprotect);
	printf("Allocated memory is now executable!");
	
	getchar();
	
	if (rv != 0){ // function succeeds
		
		DWORD threadId;
		th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec_mem, 0, 0, &threadId);
		WaitForSingleObject(th, -1);
}

	return 0;
	
}
